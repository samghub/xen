From xen-devel-bounces@lists.xen.org Thu Jul 17 06:12:32 2014
Delivered-To: tamas.lengyel@zentific.com
Received: by 10.216.1.195 with SMTP id 45csp61218wed; Thu, 17 Jul 2014
 06:12:32 -0700 (PDT)
X-Received: by 10.42.76.205 with SMTP id f13mr29581730ick.63.1405602751544;
 Thu, 17 Jul 2014 06:12:31 -0700 (PDT)
Return-Path: <xen-devel-bounces@lists.xen.org>
Received: from lists.xen.org (lists.xen.org. [50.57.142.19]) by
 mx.google.com with ESMTPS id w8si12677792icp.6.2014.07.17.06.12.31 for
 <multiple recipients> (version=TLSv1 cipher=RC4-SHA bits=128/128); Thu, 17
 Jul 2014 06:12:31 -0700 (PDT)
Received-SPF: none (google.com: xen-devel-bounces@lists.xen.org does not
 designate permitted sender hosts) client-ip=50.57.142.19;
Authentication-Results: mx.google.com; spf=neutral (google.com:
 xen-devel-bounces@lists.xen.org does not designate permitted sender hosts)
 smtp.mail=xen-devel-bounces@lists.xen.org
Received: from localhost ([127.0.0.1] helo=lists.xen.org) by lists.xen.org
 with esmtp (Exim 4.72) (envelope-from <xen-devel-bounces@lists.xen.org>) id
 1X7lSk-0001GE-KE; Thu, 17 Jul 2014 13:11:06 +0000
Received: from mail6.bemta5.messagelabs.com ([195.245.231.135]) by
 lists.xen.org with esmtp (Exim 4.72) (envelope-from
 <Andrew.Cooper3@citrix.com>) id 1X7lSj-0001FJ-1R for
 xen-devel@lists.xen.org; Thu, 17 Jul 2014 13:11:05 +0000
Received: from [85.158.139.211:18945] by server-4.bemta-5.messagelabs.com
 id DC/9E-06276-86BC7C35; Thu, 17 Jul 2014 13:11:04 +0000
X-Env-Sender: Andrew.Cooper3@citrix.com
X-Msg-Ref: server-8.tower-206.messagelabs.com!1405602661!16052158!2
X-Originating-IP: [66.165.176.63]
X-SpamReason: No, hits=0.0 required=7.0 tests=sa_preprocessor: 
 VHJ1c3RlZCBJUDogNjYuMTY1LjE3Ni42MyA9PiAzMDYwNDg=\n
X-StarScan-Received: 
X-StarScan-Version: 6.11.3; banners=-,-,-
X-VirusChecked: Checked
Received: (qmail 25250 invoked from network); 17 Jul 2014 13:11:03 -0000
Received: from smtp02.citrix.com (HELO SMTP02.CITRIX.COM) (66.165.176.63)
 by server-8.tower-206.messagelabs.com with RC4-SHA encrypted SMTP; 17 Jul
 2014 13:11:03 -0000
X-IronPort-AV: E=Sophos;i="5.01,678,1400025600"; d="scan'208";a="153733300"
Received: from accessns.citrite.net (HELO FTLPEX01CL02.citrite.net)
 ([10.9.154.239]) by FTLPIPO02.CITRIX.COM with ESMTP; 17 Jul 2014 13:10:42
 +0000
Received: from ukmail1.uk.xensource.com (10.80.16.128) by
 smtprelay.citrix.com (10.13.107.79) with Microsoft SMTP Server id
 14.3.181.6; Thu, 17 Jul 2014 09:10:40 -0400
Received: from andrewcoop.uk.xensource.com ([10.80.2.18]
 helo=andrewcoop.uk.xensource.com.)	by ukmail1.uk.xensource.com with esmtp
 (Exim 4.69)	(envelope-from <andrew.cooper3@citrix.com>)	id
 1X7lSK-0005pj-Op; Thu, 17 Jul 2014 14:10:40 +0100
From: Andrew Cooper <andrew.cooper3@citrix.com>
To: Xen-devel <xen-devel@lists.xen.org>
Date: Thu, 17 Jul 2014 14:10:36 +0100
Message-ID: <1405602637-8321-2-git-send-email-andrew.cooper3@citrix.com>
X-Mailer: git-send-email 1.7.10.4
In-Reply-To: <1405602637-8321-1-git-send-email-andrew.cooper3@citrix.com>
References: <1405602637-8321-1-git-send-email-andrew.cooper3@citrix.com>
MIME-Version: 1.0
X-DLP: MIA1
Cc: Andrew Cooper <andrew.cooper3@citrix.com>, Tim Deegan <tim@xen.org>,
 Andres Lagar-Cavilla <andres@lagarcavilla.org>, Jan Beulich
 <JBeulich@suse.com>
Subject: [Xen-devel] [PATCH 1/2] Xen/mem_event: Validate the response
 vcpu_id before acting on it.
X-BeenThere: xen-devel@lists.xen.org
X-Mailman-Version: 2.1.13
Precedence: list
List-Id: Xen developer discussion <xen-devel.lists.xen.org>
List-Unsubscribe: <http://lists.xen.org/cgi-bin/mailman/options/xen-devel>,
 <mailto:xen-devel-request@lists.xen.org?subject=unsubscribe>
List-Post: <mailto:xen-devel@lists.xen.org>
List-Help: <mailto:xen-devel-request@lists.xen.org?subject=help>
List-Subscribe: <http://lists.xen.org/cgi-bin/mailman/listinfo/xen-devel>,
 <mailto:xen-devel-request@lists.xen.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Sender: xen-devel-bounces@lists.xen.org
Errors-To: xen-devel-bounces@lists.xen.org
X-Evolution-Source: 1405632764.6771.2@l1
Content-Transfer-Encoding: 8bit

Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
CC: Jan Beulich <JBeulich@suse.com>
CC: Tim Deegan <tim@xen.org>
CC: Andres Lagar-Cavilla <andres@lagarcavilla.org>
---
 xen/arch/x86/mm/mem_sharing.c |   11 ++++++++++-
 xen/arch/x86/mm/p2m.c         |   22 ++++++++++++++++++++--
 2 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/xen/arch/x86/mm/mem_sharing.c b/xen/arch/x86/mm/mem_sharing.c
index 7293f31..ec99266 100644
--- a/xen/arch/x86/mm/mem_sharing.c
+++ b/xen/arch/x86/mm/mem_sharing.c
@@ -596,11 +596,20 @@ int mem_sharing_sharing_resume(struct domain *d)
     /* Get all requests off the ring */
     while ( mem_event_get_response(d, &d->mem_event->share, &rsp) )
     {
+        struct vcpu *v;
+
         if ( rsp.flags & MEM_EVENT_FLAG_DUMMY )
             continue;
+
+        /* Validate the vcpu_id in the response. */
+        if ( (rsp.vcpu_id >= d->max_vcpus) || !d->vcpu[rsp.vcpu_id] )
+            continue;
+
+        v = d->vcpu[rsp.vcpu_id];
+
         /* Unpause domain/vcpu */
         if ( rsp.flags & MEM_EVENT_FLAG_VCPU_PAUSED )
-            vcpu_unpause(d->vcpu[rsp.vcpu_id]);
+            vcpu_unpause(v);
     }
 
     return 0;
diff --git a/xen/arch/x86/mm/p2m.c b/xen/arch/x86/mm/p2m.c
index 642ec28..f213a39 100644
--- a/xen/arch/x86/mm/p2m.c
+++ b/xen/arch/x86/mm/p2m.c
@@ -1290,8 +1290,17 @@ void p2m_mem_paging_resume(struct domain *d)
     /* Pull all responses off the ring */
     while( mem_event_get_response(d, &d->mem_event->paging, &rsp) )
     {
+        struct vcpu *v;
+
         if ( rsp.flags & MEM_EVENT_FLAG_DUMMY )
             continue;
+
+        /* Validate the vcpu_id in the response. */
+        if ( (rsp.vcpu_id >= d->max_vcpus) || !d->vcpu[rsp.vcpu_id] )
+            continue;
+
+        v = d->vcpu[rsp.vcpu_id];
+
         /* Fix p2m entry if the page was not dropped */
         if ( !(rsp.flags & MEM_EVENT_FLAG_DROP_PAGE) )
         {
@@ -1310,7 +1319,7 @@ void p2m_mem_paging_resume(struct domain *d)
         }
         /* Unpause domain */
         if ( rsp.flags & MEM_EVENT_FLAG_VCPU_PAUSED )
-            vcpu_unpause(d->vcpu[rsp.vcpu_id]);
+            vcpu_unpause(v);
     }
 }
 
@@ -1418,11 +1427,20 @@ void p2m_mem_access_resume(struct domain *d)
     /* Pull all responses off the ring */
     while( mem_event_get_response(d, &d->mem_event->access, &rsp) )
     {
+        struct vcpu *v;
+
         if ( rsp.flags & MEM_EVENT_FLAG_DUMMY )
             continue;
+
+        /* Validate the vcpu_id in the response. */
+        if ( (rsp.vcpu_id >= d->max_vcpus) || !d->vcpu[rsp.vcpu_id] )
+            continue;
+
+        v = d->vcpu[rsp.vcpu_id];
+
         /* Unpause domain */
         if ( rsp.flags & MEM_EVENT_FLAG_VCPU_PAUSED )
-            vcpu_unpause(d->vcpu[rsp.vcpu_id]);
+            vcpu_unpause(v);
     }
 }
 
-- 
1.7.10.4


_______________________________________________
Xen-devel mailing list
Xen-devel@lists.xen.org
http://lists.xen.org/xen-devel

